// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  username  String   @unique
  name      String?
  bio       String?
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  habits              Habit[]
  completions         Completion[]
  connectionsFrom     Connection[]  @relation("ConnectionFrom")
  connectionsTo       Connection[]  @relation("ConnectionTo")
  messagesSent        Message[]     @relation("MessageFrom")
  messagesReceived    Message[]     @relation("MessageTo")
  habitSharesSent     HabitShare[]  @relation("ShareFrom")
  habitSharesReceived HabitShare[]  @relation("ShareTo")
  collections         HabitCollection[]

  @@map("users")
}

model Habit {
  id             String    @id @default(cuid())
  title          String
  description    String?
  frequency      Frequency
  userId         String
  reminderTime   String?   // Time in HH:MM format (e.g., "05:00", "14:30")
  reminderEnabled Boolean  @default(false)
  alarmDuration  Int?      // Duration in minutes (5, 10, 15, 30, 60, or -1 for "until completed")
  collectionId   String?   // Optional: belongs to a collection
  sortOrder      Int       @default(0) // For custom ordering within collections
  archived       Boolean   @default(false) // Soft delete
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  collection  HabitCollection? @relation(fields: [collectionId], references: [id], onDelete: SetNull)
  completions Completion[]
  shares      HabitShare[]

  @@index([userId])
  @@index([collectionId])
  @@index([reminderEnabled, reminderTime]) // For efficient reminder queries
  @@map("habits")
}

enum Frequency {
  DAILY
  WEEKLY
  MONTHLY
}

model Completion {
  id          String   @id @default(cuid())
  habitId     String
  userId      String
  completedAt DateTime @default(now())
  notes       String?

  habit       Habit    @relation(fields: [habitId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([habitId, completedAt, userId])
  @@index([habitId])
  @@index([userId])
  @@map("completions")
}

model Connection {
  id         String   @id @default(cuid())
  fromUserId String
  toUserId   String
  status     ConnectionStatus @default(PENDING)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  fromUser   User     @relation("ConnectionFrom", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUser     User     @relation("ConnectionTo", fields: [toUserId], references: [id], onDelete: Cascade)

  @@unique([fromUserId, toUserId])
  @@index([fromUserId])
  @@index([toUserId])
  @@map("connections")
}

enum ConnectionStatus {
  PENDING
  ACCEPTED
  REJECTED
}

model Message {
  id         String   @id @default(cuid())
  content    String
  fromUserId String
  toUserId   String
  read       Boolean  @default(false)
  createdAt  DateTime @default(now())
  
  // Reply to feature
  replyToId  String?
  replyTo    Message? @relation("MessageReply", fields: [replyToId], references: [id], onDelete: SetNull)
  replies    Message[] @relation("MessageReply")

  fromUser   User     @relation("MessageFrom", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUser     User     @relation("MessageTo", fields: [toUserId], references: [id], onDelete: Cascade)

  @@index([fromUserId])
  @@index([toUserId])
  @@index([createdAt])
  @@index([replyToId])
  @@map("messages")
}

model HabitShare {
  id          String              @id @default(cuid())
  habitId     String
  fromUserId  String
  toUserId    String
  status      HabitShareStatus    @default(PENDING)
  message     String?
  createdAt   DateTime            @default(now())
  respondedAt DateTime?

  habit       Habit               @relation(fields: [habitId], references: [id], onDelete: Cascade)
  fromUser    User                @relation("ShareFrom", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUser      User                @relation("ShareTo", fields: [toUserId], references: [id], onDelete: Cascade)

  @@unique([habitId, toUserId])
  @@index([toUserId, status])
  @@index([fromUserId])
  @@map("habit_shares")
}

enum HabitShareStatus {
  PENDING
  ACCEPTED
  REJECTED
}

model HabitCollection {
  id          String   @id @default(cuid())
  name        String
  description String?
  color       String   @default("#6366f1") // Hex color for visual distinction
  icon        String?  // Optional emoji or icon
  dayOfWeek   String?  // e.g., "Monday", "Tuesday", or null for all days
  userId      String
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  habits      Habit[]

  @@index([userId])
  @@map("habit_collections")
}
